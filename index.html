<script>
function finalizar(){
  if(!confirm("Finalizar viagem e gerar PDF?"))return;

  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF();
  let y = 10;
  let total = 0;

  // ===== CABEÇALHO =====
  pdf.setFontSize(12);
  pdf.text("Empresa: Cirurtec Hospitalar LTDA", 10, y); y+=7;
  pdf.text(`Valor do adiantamento: R$ ${parseFloat(adiantamento.value).toFixed(2)}`, 10, y); y+=7;
  pdf.text(`Nome do técnico: ${nome.value}`, 10, y); y+=7;
  pdf.text(`Data início: ${dataInicio.value}`, 10, y); y+=7;
  pdf.text(`Data fim: ${dataFim.value}`, 10, y); y+=10;

  // ===== RESUMO DE GASTOS =====
  pdf.setFontSize(11);
  pdf.text("Resumo de Gastos", 10, y); y+=8;

  despesas.forEach((d,i)=>{
    total += d.valor;
    pdf.text(
      `${i+1}. ${d.categoria} ${d.refeicao ? "- "+d.refeicao : ""} – R$ ${d.valor.toFixed(2)}`,
      10, y
    );
    y+=6;
    if(y > 270){ pdf.addPage(); y = 10; }
  });

  y+=6;
  pdf.text(`Total de despesas: R$ ${total.toFixed(2)}`, 10, y); y+=6;
  pdf.text(`Saldo final: R$ ${(adiantamento.value - total).toFixed(2)}`, 10, y);

  // ===== RESUMO DE ALIMENTAÇÃO =====
  pdf.addPage();
  y = 10;
  pdf.text("Resumo de Alimentação", 10, y); y+=8;

  let resumo = {
    "Café da manhã": [],
    "Almoço": [],
    "Café da tarde": [],
    "Jantar": []
  };

  despesas.forEach(d=>{
    if(resumo[d.refeicao]) resumo[d.refeicao].push(d.valor);
  });

  for(let r in resumo){
    if(resumo[r].length){
      const soma = resumo[r].reduce((a,b)=>a+b,0);
      pdf.text(
        `${r}: ${resumo[r].length}x – Total R$ ${soma.toFixed(2)}`,
        10, y
      );
      y+=6;
    }
  }

  // ===== ANEXOS (IMAGENS) =====
  pdf.addPage();
  y = 10;
  pdf.text("Anexos", 10, y); y+=10;

  despesas.forEach(d=>{
    d.imagens.forEach(img=>{
      if(y > 230){
        pdf.addPage();
        y = 10;
      }
      pdf.addImage(img, "JPEG", 10, y, 80, 60);
      y += 70;
    });
  });

  pdf.save("Despesas_Cirurtec.pdf");

  // Limpa viagem
  despesas = [];
  lista.innerHTML = "";
}
</script> 
