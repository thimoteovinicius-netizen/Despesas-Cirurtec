<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Despesas Cirurtec</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
body{font-family:Arial, sans-serif;background:#f4f4f4;padding:15px;}
h1{text-align:center;}
.card{background:#fff;padding:15px;border-radius:8px;margin-bottom:15px;}
input,select,button,textarea{width:100%;padding:10px;margin-top:8px;}
button{background:#1976d2;color:#fff;border:none;border-radius:6px;}
.btn-sec{background:#455a64;margin-top:5px;}
.hidden{display:none;}
.despesa{border-top:1px solid #ddd;margin-top:8px;padding-top:8px;}
table{border-collapse:collapse;width:100%;}
th, td{border:1px solid #000;padding:5px;text-align:left;font-size:10px;}
th{background:#eee;}
label{font-weight:bold;}
</style>
</head>

<body>

<h1>Despesas Cirurtec</h1>

<datalist id="cidades">
  <option value="S√£o Paulo - SP">
  <option value="Campinas - SP">
  <option value="Rio de Janeiro - RJ">
  <option value="Belo Horizonte - MG">
  <option value="Curitiba - PR">
  <option value="Porto Alegre - RS">
</datalist>

<div class="card">
  <input id="nome" placeholder="Nome do t√©cnico">
  <input id="email" type="email" placeholder="E-mail">
</div>

<div class="card">
  <label>Data in√≠cio</label>
  <input type="date" id="dataInicio">
  <label>Data final</label>
  <input type="date" id="dataFim">
  <input type="number" id="adiantamento" placeholder="Valor do adiantamento (R$)">
</div>

<div class="card">
  <h3>Roteiro da viagem</h3>
  <input id="origem" list="cidades" placeholder="Ponto inicial (cidade)">
  <button class="btn-sec" onclick="addParada()">‚ûï Adicionar ponto de parada</button>
  <div id="paradas"></div>
</div>

<div class="card">
  <h3>Nova despesa</h3>

  <select id="categoria" onchange="controleCategoria()">
    <option value="">Categoria</option>
    <option>Alimenta√ß√£o</option>
    <option>Combust√≠vel</option>
    <option>Ped√°gios</option>
    <option>Pe√ßas</option>
    <option>Hospedagem</option>
    <option>Outros</option>
    <option>Carro pr√≥prio</option>
  </select>

  <!-- Refei√ß√µes -->
  <select id="refeicao" class="hidden" onchange="controleRefeicao()">
    <option value="">Tipo de refei√ß√£o</option>
    <option>Caf√© da manh√£</option>
    <option>Almo√ßo</option>
    <option>Caf√© da tarde</option>
    <option>Jantar</option>
  </select>

  <input type="number" id="qtd" class="hidden" min="1" max="6" placeholder="Quantidade (1 a 6)" onchange="calcularRefeicao()">

  <!-- Campo para outros -->
  <input id="outrosTexto" class="hidden" placeholder="Especificar despesa">

  <!-- Campo de valor -->
  <input type="number" id="valorDespesa" placeholder="Valor (R$)">

  <!-- Campo para Carro pr√≥prio (apenas valor) -->
  <input type="number" id="valorCarro" class="hidden" placeholder="Valor (R$)">

  <!-- Bot√µes de anexos para despesas -->
  <button class="btn-sec" onclick="camera.click()">üì∏ Tirar foto</button>
  <input type="file" id="camera" accept="image/*" capture="environment" multiple hidden>

  <button class="btn-sec" onclick="galeria.click()">üñºÔ∏è Galeria</button>
  <input type="file" id="galeria" accept="image/*" multiple hidden>

  <button onclick="addDespesa()">Adicionar despesa</button>
</div>

<div class="card">
  <label>Observa√ß√µes gerais (at√© 200 caracteres)</label>
  <textarea id="observacoes" maxlength="200" placeholder="Digite suas observa√ß√µes aqui..."></textarea>
</div>

<div class="card">
  <h3>Despesas lan√ßadas</h3>
  <div id="lista"></div>
</div>

<div class="card">
  <button onclick="finalizar()">Finalizar viagem e gerar PDF</button>
</div>

<script>
let despesas=[],paradas=[];

// Formata data para dia/m√™s/ano
function formatarDataBR(data){
  if(!data) return "";
  const [y,m,d]=data.split("-");
  return `${d}/${m}/${y}`;
}

// Adiciona ponto de parada
function addParada(){
  const div=document.createElement("div");
  div.innerHTML=`<input list="cidades" placeholder="Cidade de parada">`;
  paradas.push(div);
  document.getElementById("paradas").appendChild(div);
}

// Controle de categorias
function controleCategoria(){
  refeicao.classList.toggle("hidden",categoria.value!=="Alimenta√ß√£o");
  qtd.classList.toggle("hidden",categoria.value!=="Alimenta√ß√£o");
  outrosTexto.classList.toggle("hidden",categoria.value!=="Outros");
  valorCarro.classList.toggle("hidden",categoria.value!=="Carro pr√≥prio");
  valorDespesa.classList.toggle("hidden",categoria.value==="Carro pr√≥prio");
  valorDespesa.value="";
  valorCarro.value="";
  outrosTexto.value="";
  qtd.value="";
  refeicao.value="";
}

// Controle refei√ß√µes
function controleRefeicao(){ calcularRefeicao(); }

function calcularRefeicao(){
  const valores={
    "Caf√© da manh√£":10,
    "Almo√ßo":10,
    "Caf√© da tarde":10,
    "Jantar":40
  };
  if(valores[refeicao.value] && qtd.value){
    valorDespesa.value = valores[refeicao.value]*qtd.value;
    valorDespesa.readOnly = true;
  }
}

// Adiciona despesa
function addDespesa(){
  if(!categoria.value) return alert("Preencha a categoria");

  let valor=0;
  let infoExtras="";
  if(categoria.value==="Carro pr√≥prio"){
    valor = parseFloat(valorCarro.value)||0;
  } else if(categoria.value==="Outros"){
    infoExtras=outrosTexto.value;
    if(!infoExtras) return alert("Preencha a descri√ß√£o da despesa 'Outros'");
    valor=parseFloat(valorDespesa.value)||0;
  } else {
    valor=parseFloat(valorDespesa.value)||0;
  }

  const arquivos=[...camera.files,...galeria.files].map(f=>new Promise(res=>{
    const r=new FileReader();
    r.onload=e=>res(e.target.result);
    r.readAsDataURL(f);
  }));

  Promise.all(arquivos).then(imgs=>{
    despesas.push({
      categoria:categoria.value,
      refeicao:refeicao.value,
      qtd:qtd.value,
      valor:valor,
      outros:infoExtras,
      imagens:imgs
    });

    lista.innerHTML+=`
      <div class="despesa">
        ${categoria.value} ${refeicao.value ? "- "+refeicao.value : ""} ${qtd.value ? "("+qtd.value+")" : ""} ‚Äì R$ ${valor} ${infoExtras ? "- "+infoExtras : ""}
      </div>
    `;

    categoria.value=refeicao.value=qtd.value=valorDespesa.value=outrosTexto.value=valorCarro.value="";
    camera.value=galeria.value="";
    controleCategoria();
  });
}

// Borda PDF
function desenharBorda(pdf){
  pdf.rect(5,5,200,287);
}

// Finalizar viagem e gerar PDF
function finalizar(){
  if(!confirm("Finalizar viagem e gerar PDF?")) return;

  const {jsPDF}=window.jspdf;
  const pdf=new jsPDF({orientation:"portrait",unit:"mm",format:"a4"});
  let y=15;
  const adiant=parseFloat(adiantamento.value)||0;
  let total=0;
  let porCategoria={};

  desenharBorda(pdf);
  pdf.setFontSize(11);

  // Cabe√ßalho
  pdf.text("Empresa: Cirurtec Hospitalar LTDA",10,y);y+=6;
  pdf.text(`T√©cnico: ${nome.value}`,10,y);y+=6;
  pdf.text(`Per√≠odo: ${formatarDataBR(dataInicio.value)} a ${formatarDataBR(dataFim.value)}`,10,y);y+=6;
  pdf.text(`Ponto inicial: ${origem.value}`,10,y);y+=6;
  paradas.forEach((p,i)=>{
    pdf.text(`Parada ${i+1}: ${p.querySelector("input").value}`,10,y);y+=6;
  });
  y+=4;

  // Tabela despesas
  const startX=10;
  pdf.text("Despesas detalhadas:",startX,y); y+=5;
  const colWidths=[50,40,20,25,25];
  const colTitles=["Categoria","Refei√ß√£o","Qtd","Valor unit√°rio","Total"];
  pdf.setFontSize(10);
  let x=startX;
  colTitles.forEach((t,i)=>{pdf.rect(x,y,colWidths[i],7);pdf.text(t,x+1,y+5);x+=colWidths[i];});
  y+=7;

  despesas.forEach(d=>{
    total+=d.valor;
    porCategoria[d.categoria]=(porCategoria[d.categoria]||0)+d.valor;
    let x=startX;
    const valorUnit = d.refeicao==="Jantar"?40:(d.refeicao==="Almo√ßo"?10:(d.refeicao==="Caf√© da tarde"?10:(d.refeicao==="Caf√© da manh√£"?10:d.valor)));
    const qtdVal=parseInt(d.qtd)||1;
    const totalItem=d.valor;
    [d.categoria,d.refeicao||"",qtdVal.toString(),`R$ ${valorUnit.toFixed(2)}`,`R$ ${totalItem.toFixed(2)}`].forEach((txt,i)=>{
      pdf.rect(x,y,colWidths[i],7);
      pdf.text(txt,x+1,y+5);
      x+=colWidths[i];
    });
    if(d.outros) { pdf.text("Obs: "+d.outros,startX,y+5); }
    y+=7;
    if(y>250){pdf.addPage();desenharBorda(pdf);y=15;}
  });

  y+=4;
  pdf.text("Resumo final:",startX,y);y+=6;
  pdf.text(`Valor adiantado: R$ ${adiant.toFixed(2)}`,startX,y);y+=6;
  pdf.text("Gastos por categoria:",startX,y);y+=6;
  for(let c in porCategoria){
    pdf.text(`${c}: R$ ${porCategoria[c].toFixed(2)}`,startX,y);y+=6;
  }
  y+=4;
  pdf.text(`Valor total gasto: R$ ${total.toFixed(2)}`,startX,y);y+=6;
  const saldo=adiant-total;
  pdf.text(`Saldo final: R$ ${saldo.toFixed(2)} ${saldo<0?"(NEGATIVO)":""}`,startX,y);y+=6;

  if(observacoes.value) { y+=4; pdf.text(`Observa√ß√µes: ${observacoes.value}`,startX,y); y+=6; }

  // Anexos imagens
  const anexos=[...camera.files,...galeria.files].map(f=>new Promise(res=>{
    const r=new FileReader();
    r.onload=e=>res(e.target.result);
    r.readAsDataURL(f);
  }));

  Promise.all(anexos).then(imgs=>{
    pdf.addPage(); desenharBorda(pdf); y=15; pdf.text("Anexos:",startX,y); y+=10;
    imgs.forEach(img=>{
      if(y>220){pdf.addPage();desenharBorda(pdf);y=15;}
      pdf.addImage(img,"JPEG",startX,y,80,60); y+=70;
    });
    pdf.save("Despesas_Cirurtec.pdf");

    // Limpar tudo
    despesas=[]; lista.innerHTML="";
    paradas=[]; document.getElementById("paradas").innerHTML="";
    origem.value=""; dataInicio.value=""; dataFim.value=""; adiantamento.value="";
    observacoes.value="";
    categoria.value=refeicao.value=qtd.value=valorDespesa.value=outrosTexto.value=valorCarro.value="";
    camera.value=galeria.value="";
    controleCategoria();
  });
}
</script>

</body>
</html>
