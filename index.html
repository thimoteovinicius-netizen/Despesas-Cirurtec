<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Despesas Cirurtec</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
body{font-family:Arial;background:#f4f4f4;padding:15px}
h1{text-align:center}
.card{background:#fff;padding:15px;border-radius:8px;margin-bottom:15px}
input,select,button{width:100%;padding:10px;margin-top:8px}
button{background:#1976d2;color:#fff;border:none;border-radius:6px}
.hidden{display:none}
.despesa{border-top:1px solid #ddd;margin-top:8px;padding-top:8px}
</style>
</head>

<body>

<h1>Despesas Cirurtec</h1>

<div class="card">
  <input id="nome" placeholder="Nome do técnico">
  <input id="email" type="email" placeholder="E-mail">
</div>

<div class="card">
  <input type="date" id="dataInicio">
  <input type="date" id="dataFim">
  <input type="number" id="adiantamento" placeholder="Valor do adiantamento (R$)">
</div>

<div class="card">
  <h3>Nova despesa</h3>

  <select id="categoria" onchange="controleCategoria()">
    <option value="">Categoria</option>
    <option>Alimentação</option>
    <option>Combustível</option>
    <option>Pedágios</option>
    <option>Peças</option>
    <option>Hospedagem</option>
    <option>Outros</option>
  </select>

  <select id="refeicao" class="hidden" onchange="controleRefeicao()">
    <option value="">Tipo de refeição</option>
    <option>Café da manhã</option>
    <option>Almoço</option>
    <option>Café da tarde</option>
    <option>Jantar</option>
  </select>

  <input id="outrosTexto" class="hidden" placeholder="Especificar despesa">
  <input type="number" id="valorDespesa" placeholder="Valor (R$)">

  <!-- INPUT CORRIGIDO: CÂMERA + GALERIA -->
  <input
    type="file"
    id="anexo"
    accept="image/*"
    capture="environment"
    multiple
  >

  <button onclick="addDespesa()">Adicionar despesa</button>
</div>

<div class="card">
  <h3>Despesas lançadas</h3>
  <div id="lista"></div>
</div>

<div class="card">
  <button onclick="finalizar()">Finalizar viagem e gerar PDF</button>
</div>

<script>
let despesas=[];

function formatarDataBR(data){
  if(!data) return "";
  const [y,m,d]=data.split("-");
  return `${d}/${m}/${y}`;
}

function controleCategoria(){
  refeicao.classList.toggle("hidden", categoria.value!=="Alimentação");
  outrosTexto.classList.toggle("hidden", categoria.value!=="Outros");
  valorDespesa.readOnly=false;
  valorDespesa.value="";
}

function controleRefeicao(){
  const fixos={
    "Almoço":40,
    "Café da tarde":10,
    "Jantar":40
  };
  if(fixos[refeicao.value]){
    valorDespesa.value=fixos[refeicao.value];
    valorDespesa.readOnly=true;
  }else{
    valorDespesa.readOnly=false;
    valorDespesa.value="";
  }
}

function addDespesa(){
  if(!categoria.value || !valorDespesa.value){
    alert("Preencha os dados da despesa");
    return;
  }

  const arquivos=[...anexo.files].map(f=>new Promise(res=>{
    const r=new FileReader();
    r.onload=e=>res(e.target.result);
    r.readAsDataURL(f);
  }));

  Promise.all(arquivos).then(imgs=>{
    despesas.push({
      categoria:categoria.value,
      refeicao:refeicao.value,
      outros:outrosTexto.value,
      valor:parseFloat(valorDespesa.value),
      imagens:imgs
    });

    lista.innerHTML+=`
      <div class="despesa">
        ${categoria.value} ${refeicao.value ? "- "+refeicao.value : ""} – R$ ${valorDespesa.value}
      </div>
    `;

    categoria.value=refeicao.value=outrosTexto.value=valorDespesa.value="";
    anexo.value="";
    controleCategoria();
  });
}

function desenharBorda(pdf){
  pdf.rect(5,5,200,287);
}

function finalizar(){
  if(!confirm("Finalizar viagem e gerar PDF?")) return;

  const {jsPDF}=window.jspdf;
  const pdf=new jsPDF();
  let y=15;

  const adiant=parseFloat(adiantamento.value)||0;
  let total=0;
  let porCategoria={};

  desenharBorda(pdf);

  pdf.setFontSize(11);
  pdf.text("Empresa: Cirurtec Hospitalar LTDA",10,y);y+=7;
  pdf.text(`Técnico: ${nome.value}`,10,y);y+=7;
  pdf.text(`Período: ${formatarDataBR(dataInicio.value)} a ${formatarDataBR(dataFim.value)}`,10,y);y+=7;
  pdf.text(`Valor adiantado: R$ ${adiant.toFixed(2)}`,10,y);y+=10;

  pdf.text("Resumo de despesas",10,y);y+=8;

  despesas.forEach((d,i)=>{
    total+=d.valor;
    porCategoria[d.categoria]=(porCategoria[d.categoria]||0)+d.valor;

    pdf.text(`${i+1}. ${d.categoria} ${d.refeicao ? "- "+d.refeicao : ""} – R$ ${d.valor.toFixed(2)}`,10,y);
    y+=6;
    if(y>270){
      pdf.addPage();
      desenharBorda(pdf);
      y=15;
    }
  });

  pdf.addPage();
  desenharBorda(pdf);
  y=15;

  pdf.text("Resumo Final",10,y);y+=10;
  pdf.text(`Valor adiantado: R$ ${adiant.toFixed(2)}`,10,y);y+=8;

  pdf.text("Gastos por categoria:",10,y);y+=8;
  for(let c in porCategoria){
    pdf.text(`${c}: R$ ${porCategoria[c].toFixed(2)}`,10,y);
    y+=6;
  }

  y+=6;
  pdf.text(`Valor total gasto: R$ ${total.toFixed(2)}`,10,y);y+=8;

  const saldo=adiant-total;
  pdf.text(`Saldo final: R$ ${saldo.toFixed(2)} ${saldo<0?"(NEGATIVO)":""}`,10,y);

  pdf.addPage();
  desenharBorda(pdf);
  y=15;
  pdf.text("Anexos",10,y);y+=10;

  despesas.forEach(d=>{
    d.imagens.forEach(img=>{
      if(y>220){
        pdf.addPage();
        desenharBorda(pdf);
        y=15;
      }
      pdf.addImage(img,"JPEG",10,y,80,60);
      y+=70;
    });
  });

  pdf.save("Despesas_Cirurtec.pdf");

  despesas=[];
  lista.innerHTML="";
}
</script>

</body>
</html>
